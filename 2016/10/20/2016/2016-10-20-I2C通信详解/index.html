<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Hard work makes things easier."><title>I2C通信详解 | Damon's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">I2C通信详解</h1><a id="logo" href="/.">Damon's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/blogroll/"><i class="fa fa-rss"> Blogroll</i></a><a href="/msg/"><i class="fa fa-comments"> Msg</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">I2C通信详解</h1><div class="post-meta">Oct 20, 2016<span> | </span><span class="category"><a href="/categories/程序开发/">程序开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/10/20/2016/2016-10-20-I2C通信详解/" href="/2016/10/20/2016/2016-10-20-I2C通信详解/#comments" class="ds-thread-count"></a><a data-disqus-identifier="2016/10/20/2016/2016-10-20-I2C通信详解/" href="/2016/10/20/2016/2016-10-20-I2C通信详解/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>在使用单片机的过程中，I2C 通信可以说是最被广泛使用和采纳的协议之一，采用 I2C 协议可以占用更少的资源，链接多台设备，因此它和 SPI 一样，在数字传感器中备受偏爱。</p>
<p>I²C（Inter-Integrated Circuit）字面上的意思是集成电路之间，它其实是 I²C Bus 简称，所以中文应该叫集成电路总线，它是一种串行通信总线，使用多主从架构，由飞利浦公司在1980年代为了让主板、嵌入式系统或手机用以连接低速周边设备而发展。I²C 的正确读法为“I平方C”（”I-squared-C”），而“I二C”（”I-two-C”）则是另一种错误但被广泛使用的读法。自2006年11月1日起，使用I²C协议已经不需要支付专利费，但制造商仍然需要付费以获取I²C从属设备地址。</p>
<p>I2C 主要用于电压、温度监控，EEPROM数据的读写，光模块的管理等。该总线只有两根线，SCL 和 SDA，SCL 即 Serial Clock，串行参考时钟，SDA 即 Serial Data，串行数据。</p>
<a id="more"></a>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="IO口"><a href="#IO口" class="headerlink" title="IO口"></a>IO口</h4><p>注意使用其他通讯协议时，你可能不需要特别注意 IO 的模式，但如果你使用的是模拟 I2C 的话，则最好关注下 IO 口模式设置。在 I2C 总线中有 2 个口线，SDA 和 SCL。这两个口线对为 OC 输出。</p>
<p>OC就是开漏输出(Open Collector)的简称，有时候也叫OD输出（Open-Drain），OD是对mos管而言，OC是对双极型管而言，在用法上没啥区别。相对于OC输出，另一种输出叫推挽输出(Push-Pull)，一般的MCU管脚输出可以设置这两种模式。这里分别介绍下这两种输出的不同点。</p>
<ul>
<li>推挽输出 : 可以输出高、低电平连接数字器件，推挽结构一般是指两个三极管分别受两互补信号的控制，总是在一个三极管导通的时候另一个截止.</li>
<li>开漏输出 : 输出端相当于三极管的集电极未接任何电平， 要得到高电平状态需要上拉电阻才行，适合于做电流型的驱动,其吸收电流的能力相对强(一般20ma以内)。</li>
</ul>
<p>对于MCU的开发者来讲，简单的这样理解就可以了。如果管脚设置成推挽输出模式，输出高时，IO口相当于VCC, 输出低时IO口相当于接地。如果管脚设置成开漏输出模式，输出高时，IO口的电平会和与其相连的口线进行与操作，如果都为高，才会被上拉拉成高电平，输出为低时，也相当于接地。</p>
<p>在网上我们看到很多的例程代码都是直接设置IO口的高低电平，这样做其实是不太合理的。因为我们只满足了 I2C 总线在自己这端的时序要求。而没有考虑到连接在总线上的其他器件。如果总线上其他器件的电平和MCU输出的电平一致，这样做是没问题的，如果两边的电平不一致时，这样做就有一定风险造成IO的损坏。当你输出高时，相当于IO口连接到VCC，如果对方这是恰好输出的是低电平，那就相当于短路了。因为 I2C 总线要实现线与的功能，所以 SDA 和 SCL 口线都必须设置为开漏输出模式，这种方式也是最安全的模式。我们使用 MCU 的硬件 I2C 接口时，口线会被自动设置成开漏。但有时候我们会使用 IO 口来模拟 I2C 总线，这个时候我们如何设置口线呢?</p>
<p>因为 I2C 的总线是开漏输出的，总线上接上上拉电阻后，SCL 和 SDA 就变成了高电平，这个时候挂接在总线上的任意一个 I2C 主机口可以把 SDA 拉低，即产生了一个 START 信号，挂接在总线上的其他 I2C 主机检测到这个信号后就不能去操作 I2C 总线了，否则会发生冲突。直到检测到一个 STOP 信号为止。STOP 的信号是在 SCL 口线为高时，SDA 产生一个上升沿。STOP 信号之后，I2C总线恢复到初始状态。</p>
<p>这里要分两种情况，如果MCU的口线支持开漏输出模式，则可以直接把 SDA 和 SCL 设置成开漏输出。例如 Silicon 的 C8051 系列 MCU，它的口线就支持开漏和推挽输出。如果 MCU 不支持开漏输出，例如 MSP430。当然如果软件做的合理，是可以避免这样的事情的，但总线上的很多器件都不是由你能控制的，如何设计出更合理的软件来避免这样的问题发生呢？对于不支持开漏输出MCU，我们最合理的做法是，当设置口线电平为高时，我们把口线设置成输入状态，然后利用口线上的上拉电阻来把口线拉高。这样即使是两边电平不一致时，也不会造成IO口的损坏。</p>
<h4 id="速度"><a href="#速度" class="headerlink" title="速度"></a>速度</h4><p>常见的I²C总线依传输速率的不同而有不同的模式：标准模式（100 Kbit/s）、低速模式（10 Kbit/s），但时钟频率可被允许下降至零，这代表可以暂停通信。而新一代的I²C总线可以和更多的节点（支持10比特长度的地址空间）以更快的速率通信：快速模式（400 Kbit/s）、高速模式（3.4 Mbit/s）。</p>
<h4 id="连线"><a href="#连线" class="headerlink" title="连线"></a>连线</h4><p><img src="https://raw.githubusercontent.com/noparkinghere/noparkinghere.github.io/master/img/2016-10-20-I2C通信详解/1.png" alt=""></p>
<p>如上图所示，I2C 是 OC 或 OD 输出结构，使用时必须在芯片外部进行上拉，上拉电阻R的取值根据 I2C 总线上所挂器件数量及 I2C 总线的速率有关，一般是标准模式下 R 选择 10kohm，快速模式下 R 选取 1kohm，I2C 总线上挂的 I2C 器件越多，就要求 I2C 的驱动能力越强，R 的取值就要越小，实际设计中，一般是先选取 4.7kohm 上拉电阻，然后在调试的时候根据实测的 I2C 波形再调整 R 的值。</p>
<p>I²C 只有两根通讯线：数据线 SDA 和时钟 SCL，可发送和接收数据。I2C 总线在传送数据过程中共有三种类型信号， 它们分别是：</p>
<ul>
<li>开始信号： SCL 为高电平时， SDA 由高电平向低电平跳变，开始传送数据。</li>
<li>结束信号： SCL 为高电平时， SDA 由低电平向高电平跳变，结束传送数据。</li>
<li>应答信号：接收数据的 IC 在接收到 8bit 数据后，向发送数据的 IC 发出特定的低电平脉冲，表示已收到数据。 CPU 向受控单元发出一个信号后，等待受控单元发出一个应答信号， CPU 接收到应答信号后，根据实际情况作出是否继续传递信号的判断。若未收到应答信号，由判断为受控单元出现故障。</li>
</ul>
<p>具体时序如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/noparkinghere/noparkinghere.github.io/master/img/2016-10-20-I2C通信详解/2.png" alt=""></p>
<p>I2C总线的主要时序参数有：开始建立时间 t(SUSTA)，开始保持时间 t(HDSTA)，数据建立时间 t(SUDAT)，数据保持时间 t(SUDAT) ，结束建立时间 t(SUSTO) 。</p>
<ul>
<li>开始建立时间：SCL 上升至幅度的90%与SDA下降至幅度的90%之间的时间间隔；</li>
<li>开始保持时间：SDA下降至幅度的10%与SCL下降至幅度的10%之间的时间间隔；</li>
<li>数据建立时间：SDA上升至幅度的90%或SDA下降至幅度的10%与SCL上升至幅度的10%之间的时间间隔；</li>
<li>数据保持时间：SCL下降至幅度的10%与SDA上升至幅度的10%或SDA下降至幅度的90%之间的时间间隔；</li>
<li><p>结束建立时间：SCL上升至幅度的90%与SDA上升至幅度的90%之间的时间间隔；</p>
</li>
<li><p>I2C总线传输的特点：I2C总线按字节传输，即每次传输8bits二进制数据，传输完毕后等待接收端的应答信号ACK，收到应答信号后再传输下一字节。等不到ACK信号后，传输终止。空闲情况下，SCL和SDA都处于高电平状态。</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/noparkinghere/noparkinghere.github.io/master/img/2016-10-20-I2C通信详解/3.png" alt=""></p>
<ul>
<li>判断一次传输的开始：如上图所示，I2C总线传输开始的标志是：SCL信号处于高电平期间，SDA信号出现一个由高电平向低电平的跳变。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/noparkinghere/noparkinghere.github.io/master/img/2016-10-20-I2C通信详解/4.png" alt=""></p>
<ul>
<li>判断一次传输的结束:如上图所示，I2C总线传输结束的标志是：SCL信号处于高电平期间，SDA信号出现一个由低电平向高电平的跳变。跟开始标识正好相反。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/noparkinghere/noparkinghere.github.io/master/img/2016-10-20-I2C通信详解/5.png" alt=""></p>
<ul>
<li>有效数据:在SCL处于高电平期间，SDA保持状态稳定的数据才是有效数据，只有在SCL处于低电平状态时，SDA才允许状态切换。前面已经讲过了，SCL高电平期间，SDA状态发生改变，是传输开始/.结束的标志。</li>
</ul>
<h4 id="读写"><a href="#读写" class="headerlink" title="读写"></a>读写</h4><p><img src="https://raw.githubusercontent.com/noparkinghere/noparkinghere.github.io/master/img/2016-10-20-I2C通信详解/6.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/noparkinghere/noparkinghere.github.io/master/img/2016-10-20-I2C通信详解/7.png" alt=""></p>
<p>如上图所示，I2C开始传输时，第一个字节的前7bit是地址信息(7位地址器件)，第8bit是操作标识，为“0”时表示写操作，为“1”时表示读操作，第9个时钟周期是应答信号ACK，低有效，高电平表示无应答，传输终止。在上图中还可以看出，正常情况下，写操作是I2C主设备方发起终止操作的，而读操作时，I2C主控制器在接收完最后一个数据后，不对从设备进行应答，传输终止。</p>
<p>I2C数据总线SDA是在时钟为高时有效，在时钟SCL为高期间，SDA如果发生了电平变化就会终止或重启I2C中线，所以我们在数据传输过程中，要在SCL为低的时候去更改SDA的电平。</p>
<h4 id="总线信号时序"><a href="#总线信号时序" class="headerlink" title="总线信号时序"></a>总线信号时序</h4><p>再次总结下总线的各种时序状态：</p>
<ul>
<li>总线空闲状态：SDA 和 SCL 两条信号线都处于高电平，即总线上所有的器件都释放总线，两条信号线各自的上拉电阻把电平拉高；</li>
<li>启动信号 START：信号 SCL 保持高电平，数据信号SDA的电平被拉低(即负跳变)。启动信号必须是跳变信号，而且在建立该信号前必修保证总线处于空闲状态；</li>
<li>停止信号 STOP：时钟信号SCL保持高电平，数据线被释放，使得SDA返回高电平(即正跳变)，停止信号也必须是跳变信号。</li>
<li>数据传送：SCL 线呈现高电平期间，SDA 线上的电平必须保持稳定，低电平表示 0 (此时的线电压为地电压)，高电平表示1(此时的电压由元器件的VDD决定)。只有在 SCL 线为低电平期间，SDA 上的电平允许变化。</li>
<li>应答信号 ACK：I2C 总线的数据都是以字节( 8 位)的方式传送的，发送器件每发送一个字节之后，在时钟的第9个脉冲期间释放数据总线，由接收器发送一个ACK(把数据总线的电平拉低)来表示数据成功接收。</li>
<li>无应答信号 NACK：在时钟的第 9 个脉冲期间发送器释放数据总线，接收器不拉低数据总线表示一个 NACK，NACK 有两种用途:<br>a. 一般表示接收器未成功接收数据字节；<br>b. 当接收器是主控器时，它收到最后一个字节后，应发送一个 NACK 信号，以通知被控发送器结束数据发送，并释放总线，以便主控接收器发送一个停止信号 STOP。</li>
</ul>
<p><em>起始信号是必需的，结束信号和应答信号，都可以不要。</em></p>
<h3 id="模拟-I2C"><a href="#模拟-I2C" class="headerlink" title="模拟 I2C"></a>模拟 I2C</h3><p>目前大部分 MCU 都带有 I2C 总线接口，但是芯片自带的 I2C 也有两个问题，一个是移植性较差不够通用，另外部分 MCU 不带 I2C 还是得要模拟的方式，以及一些芯片设计的 I2C 据说是存在问题的，如： stm32 的 I2C 不够稳定，efm32 的 I2C 不够节能等等。这边建议，在权衡 I2C 占用的 CPU 资源是否可以承受后，再做选择。</p>
<h4 id="IIC-选用-IO-模式"><a href="#IIC-选用-IO-模式" class="headerlink" title="IIC 选用 IO 模式"></a>IIC 选用 IO 模式</h4><p>通过上面可以知道，IIC 在通信过程中，主设备SCL始终是保持发送状态，因此这边我们可以将 SCL 设置为推挽或者开漏输出。推挽的输出能力较强，开漏输出则需要加上拉电阻，而一般 IIC 的推荐电路就是需要人为增加了上拉电阻的，因此在考虑功耗等一些情况下，可能开漏输出更好。</p>
<p><strong>而问题的关键是 SDA 到底设置为什么模式？</strong></p>
<p>网上参考资料众说纷纭，这边以我自己做实验的亲身感受为例，我推荐在作为输出时将这个脚配置为开漏输出模式；在 MCU 需要接收信号的时候，如果 MCU 本身没有限制，或者不需要精简代码的话，则将其设置为输入模式。详解：</p>
<p>将 SDA 直接设置为开漏模式：</p>
<p>这种方法一般用于之前程序的很多单片机中，开漏因为需要接上拉电阻才能改变电平，且具有线与的特性，通过读 IO 口的状态，即便是设置成了开漏输出，但仍然可以读取IO的数据状态，可以说一劳永逸，一种模式两种用途，虽然目前试过大多数MCU通过这种方式也都可以读取，但毕竟是输出模式，万一以后的设计更改了，无法读取了，则有潜在性的问题。</p>
<p>将 SDA 设置位推挽输出模式进行输出，需要读取数据时转换成输入模式：</p>
<p>最近在不少地方看到用这种方式来对 IIC 器件进行读取，感觉较为灵活，之前也将开漏转换成了这种模式。但最近实验过程中发现了不少问题，在 SDA 发送数据结束后，等待应答的这个过程中，使用推挽模式，有明显的短路风险。这段时间虽然时间很短，且接下来会立即将推挽切换为输入模式，但在单步执行测试的过程中,实际会出现很高的电流，疑似推挽的高电平输出引起了断路，用这种模式必须较为谨慎，注意各种延时时间，千万不能让器件断路烧坏。<em>在使用一个 IIC 通信的 AD 芯片过程中，一段时间后出现测量值不准，疑似可能是这种原因引起的。</em></p>
<p>SCL 使用开漏输出模式，SDA 使用开漏输出+输入模式：</p>
<p>通过上面的讨论，最终个人认为 IIC 通信过程中：SCL 使用开漏输出模式，SDA 使用开漏输出发送数据，使用输入模式读取数据，这种方法较为合理。值得注意：SDA 需要模式切换，IIC 的延迟时间无需过长，否则影响效率，这些根据手册中的标准执行。</p>
<p>以下以 EFM32 为例，给出参考代码，这边的代码只需要修改部分宏定义，就可以直接移植到 STM32 等其他单片机上。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* iic相关引脚定义 */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_PORT      gpioPortA  </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_PIN        0  </span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SCL_PORT      gpioPortA  </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SCL_PIN        1</span></div><div class="line"></div><div class="line"><span class="comment">/* iic相关功能函数定义 */</span></div><div class="line"><span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=1;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_HIGH()      GPIO_PinOutSet(IIC_SDA_PORT, IIC_SDA_PIN)  </span></div><div class="line"><span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SCL_HIGH()      GPIO_PinOutSet(IIC_SCL_PORT, IIC_SCL_PIN)</span></div><div class="line"><span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=0;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_LOW()      GPIO_PinOutClear(IIC_SDA_PORT, IIC_SDA_PIN)</span></div><div class="line"><span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SCL_LOW()      GPIO_PinOutClear(IIC_SCL_PORT, IIC_SCL_PIN)</span></div><div class="line"><span class="comment">//设置SDA为输入</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_DISABLE()  GPIO_PinModeSet(IIC_SDA_PORT, IIC_SDA_PIN, gpioModeDisabled, 0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SCL_DISABLE()  GPIO_PinModeSet(IIC_SCL_PORT, IIC_SCL_PIN, gpioModeDisabled, 0)</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SCL_SET_OUT()    GPIO_PinModeSet(IIC_SCL_PORT, IIC_SCL_PIN, gpioModePushPull, 0)</span></div><div class="line"></div><div class="line"><span class="comment">//设置为推挽输出模式</span></div><div class="line"><span class="comment">//#define IIC_SDA_SET_OUT()    GPIO_PinModeSet(IIC_SDA_PORT, IIC_SDA_PIN, gpioModePushPull, 0)</span></div><div class="line"><span class="comment">//设置为推开漏出模式</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_SET_OUT()    GPIO_PinModeSet(IIC_SDA_PORT, IIC_SDA_PIN, gpioModeWiredAndDrive, 0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_SET_IN()    GPIO_PinModeSet(IIC_SDA_PORT, IIC_SDA_PIN, gpioModeInput, 0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IIC_SDA_INPUT()      GPIO_PinInGet(IIC_SDA_PORT, IIC_SDA_PIN)</span></div><div class="line"></div><div class="line"><span class="comment">/* 初始化IIC */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IIC_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">//设置为推挽输出模式</span></div><div class="line">  IIC_SDA_SET_OUT();  </div><div class="line">  IIC_SCL_SET_OUT();    </div><div class="line"></div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=1;</span></div><div class="line">  IIC_SDA_HIGH();</div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">  IIC_SCL_HIGH();</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* 产生IIC起始信号 */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IIC_Start</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  u8 i;</div><div class="line">  <span class="comment">//IIC_SDA设置为推挽输出</span></div><div class="line">  IIC_SDA_SET_OUT();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=1;</span></div><div class="line">  IIC_SDA_HIGH();</div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">  IIC_SCL_HIGH();</div><div class="line"></div><div class="line">  i = <span class="number">5</span>;</div><div class="line">  <span class="keyword">while</span>(i--);                               <span class="comment">//setup time for stop 4us</span></div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=0;</span></div><div class="line">  IIC_SDA_LOW();</div><div class="line">  </div><div class="line">  i = <span class="number">5</span>;</div><div class="line">  <span class="keyword">while</span>(i--);                               <span class="comment">//setup time for stop 4us</span></div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="comment">//产生IIC停止信号</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IIC_Stop</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  u8 i;</div><div class="line">  <span class="comment">//IIC_SDA设置为推挽输出</span></div><div class="line">  IIC_SDA_SET_OUT();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();</div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=0;</span></div><div class="line">  IIC_SDA_LOW();</div><div class="line">    </div><div class="line">  i = <span class="number">5</span>;</div><div class="line">  <span class="keyword">while</span>(i--);                               <span class="comment">//setup time for stop 4us</span></div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">  IIC_SCL_HIGH();</div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=1;</span></div><div class="line">  IIC_SDA_HIGH();</div><div class="line"></div><div class="line">  i = <span class="number">5</span>;</div><div class="line">  <span class="keyword">while</span>(i--);                               <span class="comment">//setup time for stop 4us                 </span></div><div class="line">&#125;</div><div class="line"><span class="comment">//主机接收从机应答信号</span></div><div class="line"><span class="comment">//等待应答信号到来</span></div><div class="line"><span class="comment">//返回值：1，接收应答失败</span></div><div class="line"><span class="comment">//        0，接收应答成功</span></div><div class="line"><span class="function">u8 <span class="title">IIC_Wait_Ack</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  u8 ucErrTime=<span class="number">0</span>;</div><div class="line">  </div><div class="line">  <span class="comment">//SDA设置为输入</span></div><div class="line">  IIC_SDA_SET_IN();</div><div class="line"></div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=1;</span></div><div class="line">  IIC_SDA_HIGH();</div><div class="line">  </div><div class="line">  __nop();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">  IIC_SCL_HIGH();</div><div class="line">  </div><div class="line">  __nop();</div><div class="line">  <span class="keyword">while</span>(IIC_SDA_INPUT())</div><div class="line">  &#123;</div><div class="line">    ucErrTime++;</div><div class="line">    <span class="keyword">if</span>(ucErrTime&gt;<span class="number">250</span>)</div><div class="line">    &#123;</div><div class="line">      IIC_Stop();</div><div class="line">      <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();  </div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;  </div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="comment">//主机发送给从机应答信号</span></div><div class="line"><span class="comment">//产生ACK应答</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IIC_Ack</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();  </div><div class="line">  <span class="comment">//IIC_SDA设置为推挽输出</span></div><div class="line">  IIC_SDA_SET_OUT();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=0;</span></div><div class="line">  IIC_SDA_LOW();</div><div class="line">  __nop();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">  IIC_SCL_HIGH();</div><div class="line">  __nop();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//主机发送给从机应答信号</span></div><div class="line"><span class="comment">//不产生ACK应答        </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IIC_NAck</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();</div><div class="line">  <span class="comment">//IIC_SDA设置为推挽输出</span></div><div class="line">  IIC_SDA_SET_OUT();  </div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA=1;</span></div><div class="line">  IIC_SDA_HIGH();</div><div class="line">  __nop();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">  IIC_SCL_HIGH();</div><div class="line">  </div><div class="line">  __nop();</div><div class="line">  </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();</div><div class="line">&#125;                        </div><div class="line"><span class="comment">//IIC发送一个字节</span></div><div class="line"><span class="comment">//返回从机有无应答</span></div><div class="line"><span class="comment">//1，有应答</span></div><div class="line"><span class="comment">//0，无应答        </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">IIC_Send_Byte</span><span class="params">(u8 txd)</span></span></div><div class="line">&#123;                        </div><div class="line">    u8 t;   </div><div class="line">  </div><div class="line">  <span class="comment">//IIC_SDA设置为推挽输出</span></div><div class="line">  IIC_SDA_SET_OUT();  </div><div class="line">     </div><div class="line">  <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">  IIC_SCL_LOW();</div><div class="line">  </div><div class="line">    <span class="keyword">for</span>(t=<span class="number">0</span>;t&lt;<span class="number">8</span>;t++)</div><div class="line">    &#123;              </div><div class="line">    <span class="comment">//I2C_SDA PC0 --&gt; IIC_SDA输出数据</span></div><div class="line">        <span class="keyword">if</span> (((txd&amp;<span class="number">0x80</span>)&gt;&gt;<span class="number">7</span>) &amp; <span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">      IIC_SDA_HIGH();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> </div><div class="line">    &#123;</div><div class="line">      IIC_SDA_LOW();  </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">        txd&lt;&lt;=<span class="number">1</span>;     </div><div class="line">    __nop();   <span class="comment">//对TEA5767这三个延时都是必须的</span></div><div class="line">    </div><div class="line">    <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">    IIC_SCL_HIGH();</div><div class="line">    __nop(); </div><div class="line">    </div><div class="line">    <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">    IIC_SCL_LOW();</div><div class="line">    __nop();</div><div class="line">    &#125;</div><div class="line">&#125;       </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//读1个字节，ack=1时，发送ACK，ack=0，发送nACK   </span></div><div class="line"><span class="function">u8 <span class="title">IIC_Read_Byte</span><span class="params">(u8 ack)</span></span></div><div class="line">&#123;</div><div class="line">  u8 i, receive=<span class="number">0</span>;</div><div class="line">  </div><div class="line">  <span class="comment">//SDA设置为输入</span></div><div class="line">  IIC_SDA_SET_IN();</div><div class="line"></div><div class="line">  </div><div class="line">  </div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=0;</span></div><div class="line">    IIC_SCL_LOW();</div><div class="line">    __nop();</div><div class="line">    <span class="comment">//I2C_SCL PC1 --&gt; IIC_SCL=1;</span></div><div class="line">    IIC_SCL_HIGH();</div><div class="line">        receive &lt;&lt;= <span class="number">1</span>;</div><div class="line">    </div><div class="line">        <span class="keyword">if</span>(IIC_SDA_INPUT())</div><div class="line">      receive++;   </div><div class="line">      </div><div class="line">    __nop(); </div><div class="line">    &#125;</div><div class="line">  </div><div class="line">  __nop(); </div><div class="line"></div><div class="line">  ack ? IIC_Ack() : IIC_NAck();</div><div class="line">  </div><div class="line">    <span class="keyword">return</span> receive;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="自带-I2C"><a href="#自带-I2C" class="headerlink" title="自带 I2C"></a>自带 I2C</h3><p>这边仅以 stm32 平台通过 I2C 总线读取 EEPROM 为例，说明下如何通过芯片自带 I2C 功能来通信。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define  EEP_Firstpage      0x00</span></div><div class="line"></div><div class="line">u8 I2c_Buf_Write[256];</div><div class="line">u8 I2c_Buf_Read[256];</div><div class="line"></div><div class="line">static void I2C_GPIO_Config(void)</div><div class="line">&#123;</div><div class="line">  GPIO_InitTypeDef  GPIO_InitStructure; </div><div class="line"></div><div class="line">  /* 使能与 I2C1 有关的时钟 */</div><div class="line">  RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB,ENABLE);</div><div class="line">  RCC_APB1PeriphClockCmd(RCC_APB1Periph_I2C1,ENABLE);  </div><div class="line">    </div><div class="line">  /* PB6-I2C1_SCL、PB7-I2C1_SDA*/</div><div class="line">  GPIO_InitStructure.GPIO_P<span class="keyword">in</span> =  GPIO_Pin_6 | GPIO_Pin_7;</div><div class="line">  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</div><div class="line">  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_OD;	       // 开漏输出</div><div class="line">  GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void I2C_Mode_Configu(void)</div><div class="line">&#123;</div><div class="line">  I2C_InitTypeDef  I2C_InitStructure; </div><div class="line"></div><div class="line">  /* I2C 配置 */</div><div class="line">  I2C_InitStructure.I2C_Mode = I2C_Mode_I2C;</div><div class="line">  I2C_InitStructure.I2C_DutyCycle = I2C_DutyCycle_2;</div><div class="line">  I2C_InitStructure.I2C_OwnAddress1 =I2C1_OWN_ADDRESS7; </div><div class="line">  I2C_InitStructure.I2C_Ack = I2C_Ack_Enable ;</div><div class="line">  I2C_InitStructure.I2C_AcknowledgedAddress = I2C_AcknowledgedAddress_7bit;</div><div class="line">  I2C_InitStructure.I2C_ClockSpeed = I2C_Speed;</div><div class="line">  </div><div class="line">  /* 使能 I2C1 */</div><div class="line">  I2C_Cmd(I2C1, ENABLE);</div><div class="line"></div><div class="line">  /* I2C1 初始化 */</div><div class="line">  I2C_Init(I2C1, &amp;I2C_InitStructure);   </div><div class="line">&#125;</div><div class="line"></div><div class="line">void I2C_EE_Init(void)</div><div class="line">&#123;</div><div class="line"></div><div class="line">  I2C_GPIO_Config(); </div><div class="line"> </div><div class="line">  I2C_Mode_Configu();</div><div class="line"></div><div class="line">  /* 选择 EEPROM Block0 来写入 */</div><div class="line">  EEPROM_ADDRESS = EEPROM_Block0_ADDRESS;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void I2C_EE_BufferWrite(u8* pBuffer, u8 WriteAddr, u16 NumByteToWrite)</div><div class="line">&#123;</div><div class="line">  u8 NumOfPage = 0, NumOfSingle = 0, Addr = 0, count = 0;</div><div class="line"></div><div class="line">  Addr = WriteAddr % I2C_PageSize;</div><div class="line">  count = I2C_PageSize - Addr;</div><div class="line">  NumOfPage =  NumByteToWrite / I2C_PageSize;</div><div class="line">  NumOfSingle = NumByteToWrite % I2C_PageSize;</div><div class="line"></div><div class="line">  I2C_EE_PageWrite(pBuffer, WriteAddr, NumOfSingle);</div><div class="line">  I2C_EE_WaitEepromStandbyState();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">void I2C_EE_PageWrite(u8* pBuffer, u8 WriteAddr, u8 NumByteToWrite)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">while</span>(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)); // Added by Najoua 27/08/2008</div><div class="line">    </div><div class="line">  /* Send START condition */</div><div class="line">  I2C_GenerateSTART(I2C1, ENABLE);</div><div class="line">  </div><div class="line">  /* Test on EV5 and clear it */</div><div class="line">  <span class="keyword">while</span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT)); </div><div class="line">  </div><div class="line">  /* Send EEPROM address <span class="keyword">for</span> write */</div><div class="line">  I2C_Send7bitAddress(I2C1, EEPROM_ADDRESS, I2C_Direction_Transmitter);</div><div class="line">  </div><div class="line">  /* Test on EV6 and clear it */</div><div class="line">  <span class="keyword">while</span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));  </div><div class="line"></div><div class="line">  /* Send the EEPROM<span class="string">'s internal address to write to */    </span></div><div class="line">  I2C_SendData(I2C1, WriteAddr);  </div><div class="line"></div><div class="line">  /* Test on EV8 and clear it */</div><div class="line">  while(! I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED));</div><div class="line"></div><div class="line">  /* While there is data to be written */</div><div class="line">  while(NumByteToWrite--)  </div><div class="line">  &#123;</div><div class="line">    /* Send the current byte */</div><div class="line">    I2C_SendData(I2C1, *pBuffer); </div><div class="line"></div><div class="line">    /* Point to the next byte to be written */</div><div class="line">    pBuffer++; </div><div class="line">  </div><div class="line">    /* Test on EV8 and clear it */</div><div class="line">    while (!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* Send STOP condition */</div><div class="line">  I2C_GenerateSTOP(I2C1, ENABLE);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void I2C_EE_WaitEepromStandbyState(void)      </div><div class="line">&#123;</div><div class="line">  vu16 SR1_Tmp = 0;</div><div class="line"></div><div class="line">  do</div><div class="line">  &#123;</div><div class="line">    /* Send START condition */</div><div class="line">    I2C_GenerateSTART(I2C1, ENABLE);</div><div class="line">    /* Read I2C1 SR1 register */</div><div class="line">    SR1_Tmp = I2C_ReadRegister(I2C1, I2C_Register_SR1);</div><div class="line">    /* Send EEPROM address for write */</div><div class="line">    I2C_Send7bitAddress(I2C1, EEPROM_ADDRESS, I2C_Direction_Transmitter);</div><div class="line">  &#125;while(!(I2C_ReadRegister(I2C1, I2C_Register_SR1) &amp; 0x0002));</div><div class="line">  </div><div class="line">  /* Clear AF flag */</div><div class="line">  I2C_ClearFlag(I2C1, I2C_FLAG_AF);</div><div class="line">  /* STOP condition */    </div><div class="line">  I2C_GenerateSTOP(I2C1, ENABLE); </div><div class="line">&#125;</div><div class="line"></div><div class="line">void I2C_EE_BufferRead(u8* pBuffer, u8 ReadAddr, u16 NumByteToRead)</div><div class="line">&#123;  </div><div class="line">  //*((u8 *)0x4001080c) |=0x80; </div><div class="line">    while(I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY)); // Added by Najoua 27/08/2008</div><div class="line">    </div><div class="line">    </div><div class="line">  /* Send START condition */</div><div class="line">  I2C_GenerateSTART(I2C1, ENABLE);</div><div class="line">  //*((u8 *)0x4001080c) &amp;=~0x80;</div><div class="line">  </div><div class="line">  /* Test on EV5 and clear it */</div><div class="line">  while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT));</div><div class="line"></div><div class="line">  /* Send EEPROM address for write */</div><div class="line">  I2C_Send7bitAddress(I2C1, EEPROM_ADDRESS, I2C_Direction_Transmitter);</div><div class="line"></div><div class="line">  /* Test on EV6 and clear it */</div><div class="line">  while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));</div><div class="line">  </div><div class="line">  /* Clear EV6 by setting again the PE bit */</div><div class="line">  I2C_Cmd(I2C1, ENABLE);</div><div class="line"></div><div class="line">  /* Send the EEPROM's internal address to write to */</div><div class="line">  I2C_SendData(I2C1, ReadAddr);  </div><div class="line"></div><div class="line">  /* Test on EV8 and clear it */</div><div class="line">  <span class="keyword">while</span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTED));</div><div class="line">  </div><div class="line">  /* Send STRAT condition a second time */  </div><div class="line">  I2C_GenerateSTART(I2C1, ENABLE);</div><div class="line">  </div><div class="line">  /* Test on EV5 and clear it */</div><div class="line">  <span class="keyword">while</span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT));</div><div class="line">  </div><div class="line">  /* Send EEPROM address <span class="keyword">for</span> <span class="built_in">read</span> */</div><div class="line">  I2C_Send7bitAddress(I2C1, EEPROM_ADDRESS, I2C_Direction_Receiver);</div><div class="line">  </div><div class="line">  /* Test on EV6 and clear it */</div><div class="line">  <span class="keyword">while</span>(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED));</div><div class="line">  </div><div class="line">  /* While there is data to be <span class="built_in">read</span> */</div><div class="line">  <span class="keyword">while</span>(NumByteToRead)  </div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span>(NumByteToRead == 1)</div><div class="line">    &#123;</div><div class="line">      /* Disable Acknowledgement */</div><div class="line">      I2C_AcknowledgeConfig(I2C1, DISABLE);</div><div class="line">      </div><div class="line">      /* Send STOP Condition */</div><div class="line">      I2C_GenerateSTOP(I2C1, ENABLE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Test on EV7 and clear it */</div><div class="line">    <span class="keyword">if</span>(I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_RECEIVED))  </div><div class="line">    &#123;      </div><div class="line">      /* Read a byte from the EEPROM */</div><div class="line">      *pBuffer = I2C_ReceiveData(I2C1);</div><div class="line"></div><div class="line">      /* Point to the next location <span class="built_in">where</span> the byte <span class="built_in">read</span> will be saved */</div><div class="line">      pBuffer++; </div><div class="line">      </div><div class="line">      /* Decrement the <span class="built_in">read</span> bytes counter */</div><div class="line">      NumByteToRead--;        </div><div class="line">    &#125;   </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* Enable Acknowledgement to be ready <span class="keyword">for</span> another reception */</div><div class="line">  I2C_AcknowledgeConfig(I2C1, ENABLE);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void I2C_Test(void)</div><div class="line">&#123;</div><div class="line">  u16 i;</div><div class="line"></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"写入的数据\n\r"</span>);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> ( i=0; i&lt;=255; i++ ) //填充缓冲</div><div class="line">  &#123;   </div><div class="line">    I2c_Buf_Write[i] = i;  </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  //将I2c_Buf_Write中顺序递增的数据写入EERPOM中 </div><div class="line">  I2C_EE_BufferWrite(I2c_Buf_Write, EEP_Firstpage, 256);	 </div><div class="line"></div><div class="line">  //将EEPROM读出数据顺序保持到I2c_Buf_Read中 </div><div class="line">  I2C_EE_BufferRead(I2c_Buf_Read, EEP_Firstpage, 256); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>我们在根据芯片手册来写 I2C 驱动时，尤其需要注意以下几点：</p>
<ul>
<li>传输数据的大小端模式，这边的大小端是位大小端而不是字节。</li>
<li>时钟周期，如果通讯出现问题，试着用示波器看 CLK 波形得出通讯速度，以及看下通讯设备能够支持的速度。</li>
<li>看下应答信号是否设置成功。</li>
</ul>
<blockquote>
<p>参考链接：<br><a href="http://wenku.baidu.com/view/2a0a7f9869dc5022abea001d.html" target="_blank" rel="external">http://wenku.baidu.com/view/2a0a7f9869dc5022abea001d.html</a><br><a href="http://blog.csdn.net/zmq5411/article/details/6085740" target="_blank" rel="external">http://blog.csdn.net/zmq5411/article/details/6085740</a><br><a href="https://zh.wikipedia.org/wiki/I%C2%B2C" target="_blank" rel="external">https://zh.wikipedia.org/wiki/I%C2%B2C</a><br><a href="http://blog.sina.com.cn/s/blog_626998030102vfjx.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_626998030102vfjx.html</a></p>
</blockquote>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://noparkinghere.top/2016/10/20/2016/2016-10-20-I2C通信详解/" data-id="cj4jh4hqn005uahmudf0xyzyf" class="article-share-link">Share</a><div class="tags"><a href="/tags/嵌入式/">嵌入式</a></div><div class="post-nav"><a href="/2016/10/24/2016/2016-10-24-linux免密码命令/" class="pre">linux免密码命令</a><a href="/2016/10/19/2016/2016-10-19-usb转串口/" class="next">usb转串口</a></div><div data-thread-key="2016/10/20/2016/2016-10-20-I2C通信详解/" data-title="I2C通信详解" data-url="http://noparkinghere.top/2016/10/20/2016/2016-10-20-I2C通信详解/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/10/20/2016/2016-10-20-I2C通信详解/" data-title="I2C通信详解" data-url="http://noparkinghere.top/2016/10/20/2016/2016-10-20-I2C通信详解/" data-author-key="1" class="ds-thread"></div><div id="disqus_thread"><script>var disqus_shortname = 'noparkinghere';
var disqus_identifier = '2016/10/20/2016/2016-10-20-I2C通信详解/';
var disqus_title = 'I2C通信详解';
var disqus_url = 'http://noparkinghere.top/2016/10/20/2016/2016-10-20-I2C通信详解/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//noparkinghere.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/个人观点/">个人观点</a><span class="category-list-count">32</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活杂谈/">生活杂谈</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/程序开发/">程序开发</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载文章/">转载文章</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/软件应用/">软件应用</a><span class="category-list-count">75</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/问题总结/">问题总结</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/VPN/" style="font-size: 15px;">VPN</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/嵌入式/" style="font-size: 15px;">嵌入式</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/英语/" style="font-size: 15px;">英语</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/VPS/" style="font-size: 15px;">VPS</a> <a href="/tags/服务器/" style="font-size: 15px;">服务器</a> <a href="/tags/版本控制/" style="font-size: 15px;">版本控制</a> <a href="/tags/配置/" style="font-size: 15px;">配置</a> <a href="/tags/chrome/" style="font-size: 15px;">chrome</a> <a href="/tags/基础/" style="font-size: 15px;">基础</a> <a href="/tags/使用体验/" style="font-size: 15px;">使用体验</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/系统安装/" style="font-size: 15px;">系统安装</a> <a href="/tags/githubpage/" style="font-size: 15px;">githubpage</a> <a href="/tags/问题总结/" style="font-size: 15px;">问题总结</a> <a href="/tags/C语言/" style="font-size: 15px;">C语言</a> <a href="/tags/学习方法/" style="font-size: 15px;">学习方法</a> <a href="/tags/基础知识/" style="font-size: 15px;">基础知识</a> <a href="/tags/手机/" style="font-size: 15px;">手机</a> <a href="/tags/ssh/" style="font-size: 15px;">ssh</a> <a href="/tags/文档/" style="font-size: 15px;">文档</a> <a href="/tags/vps/" style="font-size: 15px;">vps</a> <a href="/tags/调试/" style="font-size: 15px;">调试</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="https://news.ycombinator.com/" title="Hacker News" target="_blank">Hacker News</a><ul></ul><a href="http://blog.jobbole.com/" title="Jobbole" target="_blank">Jobbole</a><ul></ul><a href="http://www.ruanyifeng.com/blog/" title="阮一峰的网络日志" target="_blank">阮一峰的网络日志</a><ul></ul><a href="http://www.panxw.com/" title="潘学文个人博客" target="_blank">潘学文个人博客</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="https://blog.0xbbc.com/" title="3004" target="_blank">3004</a><ul></ul><a href="https://emiria.io/" title="Sakara Hiroya" target="_blank">Sakara Hiroya</a></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> Recent Comments</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//noparkinghere.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Damon's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'noparkinghere'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-80280728-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>