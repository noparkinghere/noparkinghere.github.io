<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Hard work makes things easier."><title>32/70 assert调试机制 | Damon's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">32/70 assert调试机制</h1><a id="logo" href="/.">Damon's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/blogroll/"><i class="fa fa-rss"> Blogroll</i></a><a href="/msg/"><i class="fa fa-comments"> Msg</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">32/70 assert调试机制</h1><div class="post-meta">Mar 31, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2017/03/31/2017/2017-03-31-assert调试机制/" href="/2017/03/31/2017/2017-03-31-assert调试机制/#comments" class="ds-thread-count"></a><a data-disqus-identifier="2017/03/31/2017/2017-03-31-assert调试机制/" href="/2017/03/31/2017/2017-03-31-assert调试机制/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>程序的调试排错往往会占用整个工作的绝大多数时间，很多高级语言都拥有一整套的调试方法。C 语言虽然比较底层，但在调试程序时，也可以使用我之前推荐的 GDB等调试工具，但很多高手绝对不会仅依赖于调试工具，大多数人还是喜欢在开发时用 assert 来排查错误，而开发结束后，更有一些人会使用更加高效完整的日志库等来监控可能出现的 bug。</p>
<h3 id="C-标准库"><a href="#C-标准库" class="headerlink" title="C 标准库"></a>C 标准库</h3><p>C 标准库中自带了 assert.h 这个文件，可以说前人在使用时已经将排错考虑细致了，我们加入这个功能后即可以直接使用 assert 进行调试了，函数声明：<code>void assert(int expression);</code> expression 这可以是一个变量或任何 C 表达式。如果 expression 为 TRUE，assert() 不执行任何动作。如果 expression 为 FALSE，assert() 会在标准错误 stderr 上显示错误消息，并中止程序执行。实例如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">   <span class="keyword">int</span> a;</div><div class="line"></div><div class="line">   <span class="built_in">printf</span>(<span class="string">"请输入一个整数值： "</span>);</div><div class="line">   <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;a);</div><div class="line">   assert(a &gt;= <span class="number">10</span>);</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"输入的整数是： %d\n"</span>, a);</div><div class="line">&#125;</div><div class="line"></div><div class="line">请输入一个整数值： <span class="number">2</span></div><div class="line">a: a.c:<span class="number">22</span>: main: Assertion `a &gt;= <span class="number">10'</span> failed.</div><div class="line">[<span class="number">1</span>]    <span class="number">9632</span> <span class="built_in">abort</span> (core dumped)  ./a</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>网上查了下，没能找到 assert 标准库的函数原型，于是自己写了个简易版本的 assert ：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#define assert(<span class="name">expr</span>) ((<span class="name">void</span>)((<span class="name">expr</span>) || (<span class="name">_assert</span>(<span class="name">__FILE__</span>,__LINE__),<span class="number">0</span>)))</div><div class="line"></div><div class="line">void _assert(<span class="name">const</span> char *file, int line)</div><div class="line">&#123;</div><div class="line">    printf("%s:%d", file, line);</div><div class="line">    exit(0);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="MCU-自带库-assert-实现"><a href="#MCU-自带库-assert-实现" class="headerlink" title="MCU 自带库 assert 实现"></a>MCU 自带库 assert 实现</h3><p>这边我们以国内广泛使用的 stm32 v3.5.0 官方库为例，使用STM32库函数的时候，你会发现带参数的库函数前面都有assert_param语句。</p>
<p>assert_param语句是用于程序开发的时候，调试用的检测语句。默认是不开启的，你可以无视它的存在。但是，当你在调试程序的时候，可以打开这个检测机制，调试完了再关闭。具体代码如下：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/* Exported macro <span class="comment">------------------------------------------------------------*/</span></div><div class="line"><span class="comment">#ifdef  USE_FULL_ASSERT</span></div><div class="line"></div><div class="line">/**</div><div class="line">  * @brief  The assert_param macro <span class="keyword">is</span> used <span class="keyword">for</span> function's parameters check.</div><div class="line">  * @param  expr: If expr <span class="keyword">is</span> <span class="literal">false</span>, <span class="keyword">it</span> calls assert_failed function which reports </div><div class="line">  *         <span class="keyword">the</span> <span class="built_in">name</span> <span class="keyword">of</span> <span class="keyword">the</span> source <span class="built_in">file</span> <span class="keyword">and</span> <span class="keyword">the</span> source line <span class="built_in">number</span> <span class="keyword">of</span> <span class="keyword">the</span> call </div><div class="line">  *         <span class="keyword">that</span> failed. If expr <span class="keyword">is</span> <span class="literal">true</span>, <span class="keyword">it</span> returns no value.</div><div class="line">  * @retval None</div><div class="line">  */</div><div class="line">  <span class="comment">#define assert_param(expr) ((expr) ? (void)0 : assert_failed((uint8_t *)__FILE__, __LINE__))</span></div><div class="line">/* Exported functions <span class="comment">------------------------------------------------------- */</span></div><div class="line">  void assert_failed(uint8_t* <span class="built_in">file</span>, uint32_t line);</div><div class="line"><span class="comment">#else</span></div><div class="line">  <span class="comment">#define assert_param(expr) ((void)0)</span></div><div class="line"><span class="comment">#endif /* USE_FULL_ASSERT */</span></div></pre></td></tr></table></figure>
<p>如果我们想要使用 assert_param 就需要定义加入 <code>#define USE_FULL_ASSERT</code> 语句，另外我们可以发现 assert 判定失败时会调用 assert_failed() 函数，但值得注意的是， ST 的固件库中没有预留这个函数的原型，因此我们需要手动创建这个 assert_failed 函数，以下提供一个可供参考的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">assert_failed</span><span class="params">(<span class="keyword">uint8_t</span>* file, <span class="keyword">uint32_t</span> line)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">/* </span></div><div class="line">		注意：编译器 Build Output 栏是不会报错的，这边使用的是 MCU 数据如何输出，</div><div class="line">		需要根据具体情况分析，一般 MCU 都会把结果输出到串口。 </div><div class="line">	 */</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"Wrong parameters value: file %s on line %d\r\n"</span>, file, line); </div><div class="line">	<span class="keyword">while</span>(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外 assert_failed()/_assert 函数基本上是所有判定失败后都需要调用的函数，具体要根据你平台提供的库而定，有些 MCU 平台是预留了 assert_failed 这种函数的，你不需要重新定义，只需要略加补充方法即可。例如 EFM32 提供的 assert 如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DEBUG_EFM) || defined(DEBUG_EFM_USER)</span></div><div class="line"></div><div class="line"><span class="comment">/* Due to footprint considerations, we only pass file name and line number, */</span></div><div class="line"><span class="comment">/* not the assert expression (nor function name (C99)) */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">assertEFM</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">int</span> line)</span></span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> EFM_ASSERT(expr)    ((expr) ? ((void)0) : assertEFM(__FILE__, __LINE__))</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> EFM_ASSERT(expr)    ((void)(expr))</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">assertEFM</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">int</span> line)</span></span></div><div class="line">&#123;</div><div class="line">  (<span class="keyword">void</span>)file;  <span class="comment">/* Unused parameter */</span></div><div class="line">  (<span class="keyword">void</span>)line;  <span class="comment">/* Unused parameter */</span></div><div class="line"></div><div class="line">  <span class="comment">/* 预留用来定制你需要的操作 */</span></div><div class="line">  <span class="keyword">while</span> (<span class="literal">true</span>)</div><div class="line">  &#123;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>assert 调用基本上大同小异，错误时直接终止程序或者死循环，同时能够提供代码出错位置即可。开发时，不适用 assert 也是可以满足绝大多数需求的，但这时你往往需要自己写语句让错误输出出来，assert 仅是提供了一个更加便捷的操作方式而已。</p>
<blockquote>
<p>参考链接：<br><a href="http://www.runoob.com/cprogramming/c-macro-assert.html" target="_blank" rel="external">http://www.runoob.com/cprogramming/c-macro-assert.html</a><br><a href="http://www.rationmcu.com/stm32/1508.html" target="_blank" rel="external">http://www.rationmcu.com/stm32/1508.html</a></p>
</blockquote>
<hr>
<p>写作时间：21:38-22:17</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://noparkinghere.win/2017/03/31/2017/2017-03-31-assert调试机制/" data-id="cj0yzm2v8001dgwmuj9qpe7u7" class="article-share-link">Share</a><div class="tags"></div><div class="post-nav"><a href="/2017/03/31/2017/2017-03-31-腾讯传读后感/" class="pre">腾讯传读后感</a><a href="/2017/03/29/2017/2017-03-29-c语言回调函数/" class="next">30/70 C语言回调函数</a></div><div data-thread-key="2017/03/31/2017/2017-03-31-assert调试机制/" data-title="32/70 assert调试机制" data-url="http://noparkinghere.win/2017/03/31/2017/2017-03-31-assert调试机制/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2017/03/31/2017/2017-03-31-assert调试机制/" data-title="32/70 assert调试机制" data-url="http://noparkinghere.win/2017/03/31/2017/2017-03-31-assert调试机制/" data-author-key="1" class="ds-thread"></div><div id="disqus_thread"><script>var disqus_shortname = 'noparkinghere';
var disqus_identifier = '2017/03/31/2017/2017-03-31-assert调试机制/';
var disqus_title = '32/70 assert调试机制';
var disqus_url = 'http://noparkinghere.win/2017/03/31/2017/2017-03-31-assert调试机制/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//noparkinghere.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/嵌入式/">嵌入式</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程技巧/">编程技巧</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/软件安装/">软件安装</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/软件应用/">软件应用</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/配置推荐/">配置推荐</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/问题总结/">问题总结</a><span class="category-list-count">26</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/杂谈/" style="font-size: 15px;">杂谈</a> <a href="/tags/版本控制/" style="font-size: 15px;">版本控制</a> <a href="/tags/软件安装/" style="font-size: 15px;">软件安装</a> <a href="/tags/问题总结/" style="font-size: 15px;">问题总结</a> <a href="/tags/MCU/" style="font-size: 15px;">MCU</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="https://news.ycombinator.com/" title="Hacker News" target="_blank">Hacker News</a><ul></ul><a href="http://blog.jobbole.com/" title="Jobbole" target="_blank">Jobbole</a><ul></ul><a href="http://www.ruanyifeng.com/blog/" title="阮一峰的网络日志" target="_blank">阮一峰的网络日志</a><ul></ul><a href="http://www.panxw.com/" title="潘学文个人博客" target="_blank">潘学文个人博客</a><ul></ul><a href="https://www.haomwei.com/" title="屠城" target="_blank">屠城</a><ul></ul><a href="https://blog.0xbbc.com/" title="3004" target="_blank">3004</a><ul></ul><a href="https://emiria.io/" title="Sakara Hiroya" target="_blank">Sakara Hiroya</a></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> Recent Comments</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//noparkinghere.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Damon's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'noparkinghere'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-80280728-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>